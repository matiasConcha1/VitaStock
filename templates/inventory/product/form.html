{% extends "inventory/base_inventory.html" %}

{% block page_title %}{{ page_title|default:"Producto" }}{% endblock page_title %}

{% block inventory_content %}
<div class="card">
  <div class="card-body">
    <form id="product-form" method="post" enctype="multipart/form-data" novalidate>
      {% csrf_token %}
      {{ form.as_p }}
      <div class="mb-3 position-relative" id="preview-wrapper" style="display: {% if form.instance.pk and form.instance.image %}block{% else %}none{% endif %}; max-width:140px;">
        <button type="button" id="btn-clear-image" class="btn btn-sm btn-danger" style="position:absolute; top:-10px; right:-10px; border-radius:50%; padding:6px 8px; line-height:1;{% if not form.instance.pk or not form.instance.image %} display:none;{% endif %}">✕</button>
        <label class="form-label">Vista previa</label><br>
        {% if form.instance.pk and form.instance.image %}
          <img id="image-preview" src="{{ form.instance.image.url }}" alt="{{ form.instance.name }}" style="width:120px; height:120px; object-fit:cover; border-radius:10px;">
        {% else %}
          <img id="image-preview" src="" alt="Vista previa" style="width:120px; height:120px; object-fit:cover; border-radius:10px; display:none;">
        {% endif %}
      </div>
      <div class="mt-3 d-flex gap-2">
        <button type="submit" class="btn btn-primary" id="btn-submit">Guardar</button>
        <a href="{% url 'inventory:product_list' %}" class="btn btn-secondary" id="btn-cancel">Cancelar</a>
      </div>
    </form>
  </div>
</div>
{% block extra_js %}
  {{ block.super }}
  <script>
    (function() {
      const input = document.getElementById("id_image");
      const cancelBtn = document.getElementById("btn-cancel");
      if (input) {
        const previewWrapper = document.getElementById("preview-wrapper");
        const preview = document.getElementById("image-preview");
        const clearBtn = document.getElementById("btn-clear-image");
        const clearCheckbox = document.querySelector('input[type="checkbox"][name$="image-clear"]');

        // Oculta el checkbox/label "Clear" por defecto
        if (clearCheckbox) {
          const clearLabel = clearCheckbox.closest("label");
          if (clearLabel) clearLabel.style.display = "none";
        }

        input.addEventListener("change", function(ev) {
          const file = ev.target.files && ev.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = e => {
              preview.src = e.target.result;
              preview.style.display = "block";
              previewWrapper.style.display = "block";
              if (clearBtn) clearBtn.style.display = "inline-flex";
            };
            reader.readAsDataURL(file);
          }
        });

        if (clearBtn) {
          clearBtn.addEventListener("click", function() {
            if (clearCheckbox) clearCheckbox.checked = true;
            input.value = "";
            preview.src = "";
            preview.style.display = "none";
            clearBtn.style.display = "none";
          });
        }
      }

      if (cancelBtn) {
        cancelBtn.addEventListener("click", function(e) {
          e.preventDefault();
          Swal.fire({
            icon: 'question',
            title: '¿Cancelar creación?',
            text: 'No se guardará el producto.',
            showCancelButton: true,
            confirmButtonText: 'Sí, cancelar',
            cancelButtonText: 'Seguir editando',
            confirmButtonColor: '#d33',
            cancelButtonColor: '#4f46e5'
          }).then(result => {
            if (result.isConfirmed) {
              window.location.href = cancelBtn.getAttribute("href");
            }
          });
        });
      }
    })();
  </script>
{% endblock extra_js %}
{% endblock inventory_content %}
